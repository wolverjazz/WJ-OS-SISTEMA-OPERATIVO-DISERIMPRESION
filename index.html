<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WJ OS | Sistema Operativo</title>
    <link rel="icon" href="img/LOGO WJ.png" type="image/png">

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) { return false; }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; }
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; }
        }
        window.onerror = function(msg, url, line) { console.error("System Error:", msg, line); return false; };
    </script>

    <style>
        /* ESTILOS VISUALES (CSS) */
        :root {
            --bg-body: #050505;
            --bg-panel: rgba(20, 20, 23, 0.95);
            --primary: #e11d48; 
            --accent: #0ea5e9;  
            --success: #10b981;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --border: rgba(255, 255, 255, 0.1);
            --font-tech: 'Segoe UI', 'Roboto', sans-serif;
        }

        * { box-sizing: border-box; font-family: var(--font-tech); user-select: none; }
        body { background-color: var(--bg-body); color: var(--text-main); margin: 0; height: 100vh; overflow: hidden; position: relative; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 5, 0.6); backdrop-filter: blur(15px); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease, transform 0.5s ease; }
        .login-box { width: 90%; max-width: 400px; padding: 40px; background: rgba(20, 20, 25, 0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.8); position: relative; overflow: hidden; }
        .login-box::before { content:''; position: absolute; top:0; left:0; width:100%; height:4px; background: linear-gradient(90deg, transparent, var(--primary), transparent); }
        .login-logo { width: 60px; height: auto; margin-bottom: 20px; animation: heartbeat 4s infinite ease-in-out; cursor: pointer; }
        .login-title { font-size: 1.5rem; font-weight: 800; letter-spacing: 2px; margin-bottom: 5px; }
        .login-subtitle { font-size: 0.8rem; color: var(--text-muted); letter-spacing: 4px; margin-bottom: 40px; text-transform: uppercase; }
        .login-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 15px; border-radius: 12px; color: white; margin-bottom: 15px; font-size: 1rem; text-align: center; transition: 0.3s; }
        .login-input:focus { border-color: var(--accent); outline: none; background: rgba(0,0,0,0.5); }
        .login-input.master-mode { border-color: var(--primary); box-shadow: 0 0 15px rgba(225, 29, 72, 0.3); }
        .btn-login { width: 100%; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(45deg, #111, #222); color: white; font-weight: bold; cursor: pointer; border: 1px solid #333; transition: 0.3s; margin-top: 10px; }
        .btn-login:hover { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 20px rgba(225, 29, 72, 0.4); }

        /* LAUNCHER */
        #launcher-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 0; pointer-events: none; }
        .ghost-logo { position: absolute; z-index: -1; opacity: 0.15; filter: blur(2px); transform: scale(1.2); display: flex; justify-content: center; align-items: center; width: 100%; }
        .ghost-logo img { width: 35vw; max-width: 500px; filter: grayscale(100%); }
        .widget-clock { text-align: center; z-index: 1; text-shadow: 0 10px 30px rgba(0,0,0,0.9); margin-top: -50px; }
        .time-display { font-size: clamp(4rem, 10vw, 9rem); font-weight: 100; letter-spacing: -5px; line-height: 1; font-variant-numeric: tabular-nums; }
        .date-display { font-size: clamp(1rem, 2vw, 1.2rem); color: var(--text-muted); text-transform: uppercase; letter-spacing: 4px; margin-top: 10px; font-weight: 600; }
        .weather-widget { display: inline-flex; align-items: center; gap: 10px; margin-top: 20px; padding: 8px 20px; background: rgba(255,255,255,0.05); border-radius: 30px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); font-size: 1.1rem; color: #ddd; }

        /* HEADER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; }
        header { padding: 0 30px; height: 110px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); transition: 0.3s; }
        .system-id { font-size: 0.9rem; font-weight: 300; letter-spacing: 2px; color: #888; display: flex; align-items: center; gap: 10px; white-space: nowrap; }
        .system-id b { color: white; font-weight: 700; }
        .system-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); }
        .client-brand { display: flex; justify-content: center; align-items: center; height: 100%; }
        .client-brand img { height: 85px; width: auto; transition: transform 0.3s; filter: drop-shadow(0 0 15px rgba(255,255,255,0.1)); }
        .client-brand:hover img { transform: scale(1.05); }
        .nav-controls { display: flex; gap: 10px; justify-content: flex-end; }
        .nav-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); padding: 10px 16px; border-radius: 8px; cursor: pointer; backdrop-filter: blur(5px); transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; font-weight: 600; white-space: nowrap;}
        .nav-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
        .nav-btn.primary { background: var(--primary); border-color: var(--primary); box-shadow: 0 4px 15px rgba(225, 29, 72, 0.4); }
        .nav-btn.finance { color: #fbbf24; border-color: rgba(251, 191, 36, 0.2); }
        .nav-btn.history { color: #a78bfa; border-color: rgba(167, 139, 250, 0.3); }

        /* BOARD */
        .board-wrapper { flex: 1; padding: 20px 40px; display: flex; gap: 20px; overflow-x: auto; overflow-y: hidden; justify-content: flex-start; align-items: flex-start; scroll-behavior: smooth; }
        .column { flex: 1; min-width: 260px; max-width: 420px; display: flex; flex-direction: column; transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); height: 100%; }
        .col-header { background: var(--bg-panel); backdrop-filter: blur(15px); padding: 15px 20px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); margin-bottom: 12px; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 20; position: relative; }
        .col-header:hover { border-color: rgba(255,255,255,0.3); background: rgba(40, 40, 45, 0.9); }
        .col-body { background: rgba(10, 10, 12, 0.6); border-radius: 0 0 16px 16px; overflow-y: auto; overflow-x: hidden; height: calc(100% - 70px); transition: opacity 0.4s ease; opacity: 1; padding: 8px; margin-top: -10px; padding-top: 20px; scrollbar-width: thin; scrollbar-color: #333 transparent; }
        .column.retracted .col-body { height: 0; opacity: 0; padding: 0; pointer-events: none; }
        
        /* CARD */
        .card { background: rgba(40, 40, 45, 0.4); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; position: relative; transition: transform 0.2s, background 0.2s; }
        .card:hover { transform: translateY(-4px); background: rgba(60, 60, 65, 0.7); border-color: #666; }
        .card-folio { font-family: 'Courier New', monospace; color: var(--accent); background: rgba(14, 165, 233, 0.1); padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .card-badge { font-size: 0.65rem; padding: 3px 6px; border-radius: 4px; display: inline-block; margin-bottom: 5px; font-weight: bold; letter-spacing: 0.5px; }
        .badge-internal { background: #3f3f46; color: white; }
        .badge-external { background: var(--purple); color: white; box-shadow: 0 0 8px rgba(139, 92, 246, 0.4); }
        .card-client { font-weight: 800; margin: 5px 0; color: white; font-size: 1.1rem; }
        .card-desc { font-size: 0.85rem; color: #ccc; }
        .card-foot { margin-top: 12px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; }
        .card-actions { display: flex; gap: 8px; }
        .act-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; transition: 0.2s; opacity: 0.7; }
        .act-btn:hover { opacity: 1; transform: scale(1.1); }

        /* FOOTER */
        .wj-signature { position: fixed; bottom: 20px; left: 30px; display: flex; align-items: center; gap: 12px; z-index: 50; }
        .wj-logo-anim { width: 35px; height: auto; animation: heartbeat 4s infinite ease-in-out; }
        .wj-text { font-size: 0.7rem; color: rgba(255,255,255,0.3); font-weight: 600; letter-spacing: 1px; }
        @keyframes heartbeat { 0% { opacity: 0.5; transform: scale(1); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); } 50% { opacity: 1; transform: scale(1.05); filter: drop-shadow(0 0 8px rgba(225, 29, 72, 0.4)); } 100% { opacity: 0.5; transform: scale(1); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); } }

        /* MODALES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); z-index: 100; display: none; justify-content: center; align-items: center; opacity: 0; transition: 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-window { width: 95%; max-width: 1200px; height: 90vh; background: #121215; border: 1px solid #333; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px 25px; background: #1a1a1d; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;}
        .editor-container { display: flex; height: 100%; overflow: hidden; }
        .editor-left { flex: 1; padding: 25px; overflow-y: auto; }
        .editor-right { width: 340px; background: #0f0f10; border-left: 1px solid #333; padding: 25px; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.3); overflow-y: auto;}
        
        .summary-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 20px; color: white; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem; color: #aaa; }
        .summary-val { color: white; font-weight: 600; }
        .big-price { font-size: 2.2rem; font-weight: 800; color: var(--success); margin: 5px 0 15px; }
        .summary-actions { margin-top: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px;}
        .btn-save { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-save:hover { filter: brightness(1.1); }
        .btn-del { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .accordion { background: #1c1c20; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; overflow: hidden; }
        .accordion.open { border-color: #555; }
        .acc-head { padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; font-weight: 700; color: #ddd; background: rgba(255,255,255,0.02); font-size: 0.9rem; }
        .acc-body { padding: 15px; display: none; border-top: 1px solid #333; }
        .accordion.open .acc-body { display: block; }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; flex-wrap: wrap; }
        .f-col { flex: 1; min-width: 100px; } .f-mini { width: 70px; } .f-mid { width: 120px; }
        label { display: block; font-size: 0.65rem; color: #888; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; background: #080808; border: 1px solid #333; color: white; padding: 8px; border-radius: 6px; font-size: 0.9rem; resize: vertical; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; }
        .finish-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .finish-item { background: #080808; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #333; cursor: pointer; color: #777; transition: 0.2s; font-size: 0.8rem; }
        .finish-item.active { background: rgba(16, 185, 129, 0.15); border-color: var(--success); color: var(--success); font-weight: bold; }

        /* HISTORIAL ESTILOS */
        .history-controls { padding: 20px; border-bottom: 1px solid #333; display: flex; gap: 10px; align-items: center; background: #151518; }
        .h-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid #333; background: #222; color: #aaa; cursor: pointer; font-size: 0.8rem; }
        .h-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .history-list { flex: 1; overflow-y: auto; padding: 0; }
        .history-row { display: grid; grid-template-columns: 80px 1fr 1fr 100px; padding: 15px 25px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; font-size: 0.9rem; }
        .history-row:hover { background: rgba(255,255,255,0.02); }
        .h-folio { font-family: monospace; color: var(--accent); }
        .h-client { font-weight: bold; color: white; }
        .h-desc { color: #888; font-size: 0.8rem; }
        .h-amount { color: var(--success); font-weight: bold; text-align: right; }
        .h-total-box { padding: 20px; background: #1a1a1d; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }

        /* RESPONSIVE */
        @media (max-width: 1000px) {
            header { height: auto; padding: 15px; grid-template-columns: 1fr; gap: 10px; justify-items: center; }
            .nav-controls { justify-content: center; width: 100%; overflow-x: auto; padding-bottom: 5px; }
            .client-brand img { height: 60px; }
            .system-id { display: none; } 
            .editor-container { flex-direction: column; overflow-y: auto; }
            .editor-left { width: 100%; overflow: visible; }
            .editor-right { width: 100%; border-left: none; border-top: 1px solid #333; height: auto; flex-shrink: 0; }
            .modal-window { height: 100vh; max-height: 100vh; border-radius: 0; }
            .wj-signature { bottom: 10px; left: 10px; }
            .wj-text { display: none; } 
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <img src="img/LOGO WJ.png" class="login-logo" ondblclick="enableMasterMode()">
            <div class="login-title">WJ OS</div>
            <div class="login-subtitle">SISTEMA OPERATIVO</div>
            <input type="password" id="login-pass" class="login-input" placeholder="CONTRASE√ëA">
            <button class="btn-login" onclick="attemptLogin()">INICIAR SESI√ìN</button>
            <div id="login-msg" style="margin-top:15px; color:#f43f5e; font-size:0.8rem; height:1rem;"></div>
        </div>
    </div>

    <div id="launcher-bg">
        <div class="ghost-logo"><img src="img/LOGO DISERIMPRESION.webp" alt="Ghost Logo"></div>
        <div class="widget-clock">
            <div class="time-display" id="clock-time">00:00</div>
            <div class="date-display" id="clock-date">CONECTANDO...</div>
            <div class="weather-widget" id="weather-display"><span>üìç Localizando...</span></div>
        </div>
    </div>

    <div id="ui-layer" style="display:none;">
        <header>
            <div class="system-id"><div class="system-dot"></div>WJ OS <b>SISTEMA OPERATIVO</b></div>
            <div class="client-brand"><img src="img/LOGO DISERIMPRESION.webp" alt="Diser Impresion"></div>
            <div class="nav-controls">
                <button class="nav-btn finance" onclick="openCaja()">üí∞ Caja</button> 
                <button class="nav-btn history" onclick="openHistory()">üìÇ Historial</button>
                <button class="nav-btn primary" onclick="openEditor()">+ Nueva</button>
                <button class="nav-btn" onclick="openConfig()">‚öôÔ∏è Config</button>
                <button class="nav-btn" onclick="toggleAllCols()">üîÉ Retraer</button>
                <button class="nav-btn" onclick="location.reload()">üîí</button>
            </div>
        </header>
        <div class="board-wrapper" id="board-container"></div>
        <div class="wj-signature"><img src="img/LOGO WJ.png" class="wj-logo-anim" title="System Alive"><div class="wj-text">Powered by<br>WJ DIGITAL STUDIO</div></div>
    </div>

    <div class="modal-overlay" id="editor-modal">
        <div class="modal-window">
            <div class="modal-header">
                <div style="font-weight:700; font-size:1.1rem; display:flex; align-items:center; gap:10px;">üìù Orden</div>
                <button onclick="closeModal()" style="background:none; border:none; color:#888; font-size:1.2rem; cursor:pointer;">‚úï</button>
            </div>
            <div class="editor-container">
                <div class="editor-left">
                    <div style="background:#1c1c20; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #333;">
                        <div class="form-row">
                            <div class="f-mini"><label>Folio</label><input type="text" id="inp-folio" readonly style="color:var(--accent); font-weight:bold;"></div>
                            <div class="f-mid"><label>Fecha</label><input type="text" id="inp-date" readonly></div>
                            <div class="f-mid"><label>Entrega</label><input type="date" id="inp-date-delivery" style="color-scheme:dark;"></div>
                        </div>
                        <div class="form-row"><div class="f-col"><label>Cliente</label><input type="text" id="inp-client" placeholder="NOMBRE CLIENTE"></div><div class="f-mid"><label>Tel / WA</label><input type="tel" id="inp-phone"></div></div>
                        <div class="form-row" style="margin-bottom:0;"><div class="f-col"><label>Trabajo</label><input type="text" id="inp-desc" placeholder="DESCRIPCI√ìN"></div></div>
                    </div>
                    
                    <div class="accordion open"><div class="acc-head" onclick="toggleAcc(this)">üì¶ Producci√≥n & Maquila <span>‚ñº</span></div><div class="acc-body">
                        <div class="form-row" style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
                            <div class="f-col">
                                <label style="color:var(--purple); font-weight:bold;">Tipo de Producci√≥n (Asignar a:)</label>
                                <select id="inp-vendor">
                                    <option value="">üè† Producci√≥n Interna (Local)</option>
                                    </select>
                            </div>
                        </div>
                        <div class="form-row"><div class="f-mini"><label>Cant.</label><input type="number" id="inp-qty"></div><div class="f-col"></div></div>
                        <div class="form-row"><div class="f-mid"><label>Del</label><input type="number" id="inp-f-start"></div><div class="f-mid"><label>Al</label><input type="number" id="inp-f-end"></div><div class="f-col" style="text-align:right;"><label>Costo Folio $</label><input type="number" id="cost-folio" style="width:100px; text-align:right;" oninput="calc()"></div></div>
                    </div></div>

                    <div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">üìÑ Papel <span>‚ñº</span></div><div class="acc-body">
                        <div class="form-row"><div class="f-col"><label>Tipo</label><input type="text" id="inp-p-type"></div><div class="f-col"><label>Tama√±o</label><input type="text" id="inp-p-size"></div></div>
                        <div class="form-row"><div class="f-col"><label>Orig.</label><input type="text" id="inp-p-orig"></div><div class="f-col"><label>Int. 1</label><input type="text" id="inp-p-int1"></div><div class="f-col"><label>Int. 2</label><input type="text" id="inp-p-int2"></div><div class="f-col"><label>Final</label><input type="text" id="inp-p-final"></div></div>
                        <div class="form-row" style="justify-content:flex-end;"><div class="f-mid" style="text-align:right;"><label>Costo Papel $</label><input type="number" id="cost-paper" style="text-align:right;" oninput="calc()"></div></div>
                    </div></div>
                    <div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">üé® Impresi√≥n <span>‚ñº</span></div><div class="acc-body">
                        <label style="color:var(--primary); margin-bottom:5px;">FRENTE</label><div class="form-row"><div class="f-col"><label>Sel</label><input type="text" id="inp-f-sel"></div><div class="f-col"><label>Lin</label><input type="text" id="inp-f-line"></div><div class="f-mini"><label>Tintas</label><input type="number" id="inp-f-inks"></div><div class="f-col"><label>Color</label><input type="text" id="inp-f-col"></div></div>
                        <label style="color:var(--primary); margin-top:10px; margin-bottom:5px;">VUELTA</label><div class="form-row"><div class="f-col"><label>Sel</label><input type="text" id="inp-v-sel"></div><div class="f-col"><label>Lin</label><input type="text" id="inp-v-line"></div><div class="f-mini"><label>Tintas</label><input type="number" id="inp-v-inks"></div><div class="f-col"><label>Color</label><input type="text" id="inp-v-col"></div></div>
                        <div class="form-row" style="justify-content:flex-end;"><div class="f-mid" style="text-align:right;"><label>Costo Impresi√≥n $</label><input type="number" id="cost-print" style="text-align:right;" oninput="calc()"></div></div>
                    </div></div>
                    <div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">üìº Placas, Negativos & Tiros <span>‚ñº</span></div><div class="acc-body">
                             <div class="form-row"><div class="f-col"><label>Placas</label><input type="number" id="inp-plates-qty" placeholder="0"></div><div class="f-col"><label>Negativos</label><input type="number" id="inp-negs-qty" placeholder="0"></div><div class="f-col"><label>Tiros</label><input type="number" id="inp-shots-qty" placeholder="0"></div></div>
                            <div class="form-row" style="justify-content:flex-end;"><div class="f-mid" style="text-align:right;"><label>Costo P/N/T $</label><input type="number" id="cost-plates" style="text-align:right;" oninput="calc()"></div></div>
                    </div></div>
                    <div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">üõ†Ô∏è Acabados <span>‚ñº</span></div><div class="acc-body">
                        <div class="finish-grid" id="finishes-grid"></div>
                        <div class="form-row" style="margin-top:15px;"><div class="f-col"><label>Otros</label><input type="text" id="inp-f-other"></div><div class="f-mid" style="text-align:right;"><label>Costo Terminado $</label><input type="number" id="cost-finish" style="text-align:right;" oninput="calc()"></div></div>
                    </div></div>
                    <div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">üì´ Entrega & Notas <span>‚ñº</span></div><div class="acc-body">
                             <div class="form-row"><div class="f-col"><label>Observaciones</label><textarea id="inp-obs" rows="3"></textarea></div><div class="f-col"><label>Email</label><input type="email" id="inp-email"></div></div>
                    </div></div>
                </div>
                <div class="editor-right">
                    <div class="summary-title">Resumen</div>
                    <div class="summary-row"><span>Folios:</span><span id="txt-folio" class="summary-val">$0.00</span></div>
                    <div class="summary-row"><span>Papel:</span><span id="txt-paper" class="summary-val">$0.00</span></div>
                    <div class="summary-row"><span>Impresi√≥n:</span><span id="txt-print" class="summary-val">$0.00</span></div>
                    <div class="summary-row"><span>P/N/Tiros:</span><span id="txt-plates" class="summary-val">$0.00</span></div>
                    <div class="summary-row"><span>Terminado:</span><span id="txt-finish" class="summary-val">$0.00</span></div>
                    <div style="margin: 15px 0; border-top:1px dashed #444; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.8rem; color:#888;">IVA (16%)</span><input type="checkbox" id="check-iva" onchange="calc()" style="width:20px;">
                    </div>
                    <div class="big-price" id="disp-total" style="text-align:right;">$0.00</div>
                    <div style="margin-bottom:10px;"><label style="color:#888;">ANTICIPO</label><input type="number" id="inp-advance" oninput="calc()" style="background:#222; border-color:#444; color:var(--success); font-weight:bold; font-size:1.1rem; text-align:right;"></div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;"><span style="font-weight:bold; color:white;">Restante:</span><span id="disp-balance" style="font-size:1.2rem; font-weight:bold; color:var(--primary);">$0.00</span></div>
                    <div class="summary-actions"><button class="btn-save" onclick="saveOrder()">üíæ Guardar Orden</button><button class="btn-del" onclick="deleteOrder()">üóë Eliminar</button></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="history-modal">
        <div class="modal-window" style="max-width:900px;">
            <div class="modal-header">
                <div style="font-weight:700; font-size:1.1rem;">üìÇ Historial de Entregas</div>
                <button onclick="closeModal()" style="background:none; border:none; color:#888; font-size:1.2rem; cursor:pointer;">‚úï</button>
            </div>
            <div class="history-controls">
                <button class="h-btn active" onclick="renderHistory('today')">Hoy</button>
                <button class="h-btn" onclick="renderHistory('week')">Semana</button>
                <button class="h-btn" onclick="renderHistory('all')">Todo</button>
            </div>
            <div class="history-list" id="history-list-container"></div>
            <div class="h-total-box">
                <div style="color:#888; font-size:0.9rem;">Total Entregado</div>
                <div id="history-total-val" style="font-size:1.8rem; font-weight:800; color:white;">$0.00</div>
            </div>
            <div class="modal-footer" style="justify-content:flex-end;">
                 <button onclick="clearHistory()" style="background:none; border:1px solid #444; color:#666; padding:8px 15px; border-radius:8px; cursor:pointer; font-size:0.8rem;">Vaciar Todo</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="caja-modal"><div class="login-box" style="width:90%; max-width:600px; background:#18181b;"><h2>üí∞ Corte de Caja</h2><div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin:30px 0;"><div style="background:#111; padding:20px; border-radius:10px; min-width:200px;"><div style="font-size:1.5rem;">üíµ</div><div style="color:var(--success);">Cobrado</div><div id="caja-cobrado" style="font-size:1.5rem; font-weight:bold;">$0.00</div></div><div style="background:#111; padding:20px; border-radius:10px; min-width:200px;"><div style="font-size:1.5rem;">üìâ</div><div style="color:var(--primary);">Por Cobrar</div><div id="caja-por-cobrar" style="font-size:1.5rem; font-weight:bold;">$0.00</div></div></div><button onclick="closeModal()" style="padding:10px 30px; border-radius:8px; border:none; background:#333; color:white; cursor:pointer;">Cerrar</button></div></div>
    
    <div class="modal-overlay" id="config-modal">
        <div class="login-box" style="width:95%; max-width:900px; background:#18181b; text-align:left; overflow-y:auto; max-height:90vh;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>‚öôÔ∏è Panel de Configuraci√≥n</h2>
                <button onclick="closeModal()" style="background:none; border:none; color:#888; font-size:1.2rem; cursor:pointer;">‚úï</button>
            </div>
            
            <div style="display:flex; gap:25px; flex-wrap:wrap;">
                <div style="flex:1; min-width:250px;">
                    <label style="color:var(--accent); font-weight:bold;">Datos Generales</label>
                    <div style="margin-top:10px;">
                        <label>Nombre Negocio</label><input type="text" id="cfg-name" class="login-input" style="text-align:left;">
                        <label>Contrase√±a Cliente</label><input type="text" id="cfg-pass" class="login-input" style="text-align:left;">
                        <label>Folio Actual</label><input type="number" id="cfg-folio" class="login-input" style="text-align:left;">
                        <label>Cuenta Normal (WA)</label><textarea id="cfg-norm" rows="2" style="width:100%; background:#000; border:1px solid #333; color:white; margin-bottom:10px;"></textarea>
                        <label>Cuenta Fiscal (WA)</label><textarea id="cfg-fisc" rows="2" style="width:100%; background:#000; border:1px solid #333; color:white;"></textarea>
                    </div>
                </div>
                
                <div style="flex:1; min-width:250px; display:flex; flex-direction:column; gap:20px; border-left:1px solid #333; padding-left:20px;">
                    
                    <div>
                        <label style="color:var(--purple); font-weight:bold;">üöö Directorio de Maquileros</label>
                        <div style="display:flex; gap:5px; margin:10px 0;">
                            <input type="text" id="cfg-new-vendor" class="login-input" style="margin:0; text-align:left; padding:8px;" placeholder="Nuevo proveedor...">
                            <button onclick="addVendor()" style="background:var(--success); color:white; border:none; border-radius:8px; padding:0 15px; font-weight:bold; cursor:pointer;">+</button>
                        </div>
                        <div id="cfg-vendors-list" style="background:#000; border:1px solid #333; border-radius:8px; padding:10px; max-height:140px; overflow-y:auto;"></div>
                    </div>

                    <div>
                        <label style="color:var(--accent); font-weight:bold;">üõ†Ô∏è Opciones de Acabados</label>
                        <div style="display:flex; gap:5px; margin:10px 0;">
                            <input type="text" id="cfg-new-finish" class="login-input" style="margin:0; text-align:left; padding:8px;" placeholder="Ej. Hot Stamping, Laminado...">
                            <button onclick="addConfigFinish()" style="background:var(--success); color:white; border:none; border-radius:8px; padding:0 15px; font-weight:bold; cursor:pointer;">+</button>
                        </div>
                        <div id="cfg-finishes-list" style="background:#000; border:1px solid #333; border-radius:8px; padding:10px; max-height:140px; overflow-y:auto;"></div>
                    </div>

                </div>
            </div>
            <div style="text-align:center; margin-top:30px; border-top:1px solid #333; padding-top:20px;">
                <button onclick="saveConfig()" style="background:var(--accent); color:white; border:none; padding:12px 40px; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">Guardar Todos los Cambios</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD_jFR8Be7LFDp6eZ94jJSsC9Rnme3upGs",
            authDomain: "wj-os-diserimpresion.firebaseapp.com",
            databaseURL: "https://wj-os-diserimpresion-default-rtdb.firebaseio.com",
            projectId: "wj-os-diserimpresion",
            storageBucket: "wj-os-diserimpresion.firebasestorage.app",
            messagingSenderId: "1013243206959",
            appId: "1:1013243206959:web:742f69aae50fc91d5ad5da"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dbRef = ref(database, 'wjos_db_diser'); 

        const defaultFinishes = ["Pleca", "Perforado", "Suaje", "Barniz", "Vta", "Compaginado", "Pegado", "Corte", "Doblez", "Dise√±o", "Grapa", "Plast. Bte", "Plast. Matte", "Fte", "Vta (Acabado)"];

        let localDB = { 
            orders: [], 
            history: [],
            config: { 
                name: 'DISER IMPRESION', pass: 'DISER2026', folio: 0, accNorm: '', accFisc: '',
                vendors: ["Lonas y Etiquetas", "Conexi√≥n", "Girokristal", "Impreneth"],
                finishes: defaultFinishes
            } 
        };
        const MASTER_KEY = "WJ#ROOT_OS_26";

        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localDB = data;
                if(!localDB.orders) localDB.orders = [];
                if(!localDB.history) localDB.history = [];
                if(!localDB.config) localDB.config = { name: 'DISER IMPRESION', pass: 'DISER2026', folio: 0, vendors: [], finishes: [] };
                // Validaciones para asegurar que existan los arrays din√°micos
                if(!localDB.config.vendors) localDB.config.vendors = ["Lonas y Etiquetas", "Conexi√≥n", "Girokristal", "Impreneth"];
                if(!localDB.config.finishes) localDB.config.finishes = defaultFinishes;
            } else {
                saveToCloud(); 
            }
            
            // Renderizar din√°micamente los botones de acabados con los datos reci√©n cargados
            initFinishes();

            updateClock();
            document.getElementById('login-screen').style.display = 'flex';
            initWeather();
            renderBoard();
            if(document.getElementById('history-modal').classList.contains('active')) renderHistory('today');
            
        }, (error) => {
            console.error("Firebase Error:", error);
        });

        function saveToCloud() { set(dbRef, localDB).catch((error) => console.error(error)); }

        window.attemptLogin = function() { 
            const input = document.getElementById('login-pass').value; 
            const msg = document.getElementById('login-msg'); 
            if (input === localDB.config.pass || input === MASTER_KEY || input === "DISER2026") { 
                document.getElementById('login-screen').style.opacity = '0'; 
                document.getElementById('login-screen').style.transform = 'scale(1.1)'; 
                setTimeout(() => { 
                    document.getElementById('login-screen').style.display = 'none'; 
                    document.getElementById('ui-layer').style.display = 'flex'; 
                }, 500); 
            } else { msg.textContent = "ACCESO DENEGADO"; document.getElementById('login-pass').style.borderColor = "red"; } 
        };

        window.enableMasterMode = function() { const inp = document.getElementById('login-pass'); inp.classList.add('master-mode'); inp.placeholder = "MASTER KEY REQUIRED"; inp.focus(); };

        window.initWeather = function() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude; const lon = position.coords.longitude;
                    let city = "Ubicaci√≥n";
                    try { const cityRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`); const cityData = await cityRes.json(); city = cityData.address.city || cityData.address.town || cityData.address.village || "Mi Ubicaci√≥n"; } catch(e) {}
                    try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`); const data = await res.json(); const temp = Math.round(data.current_weather.temperature); const code = data.current_weather.weathercode; let icon = "üå§"; if(code < 3) icon = "‚òÄÔ∏è"; else if(code < 50) icon = "‚òÅÔ∏è"; else icon = "üåß"; document.getElementById('weather-display').innerHTML = `<span>${icon} ${city}</span> <span style="opacity:0.3">|</span> <span>${temp}¬∞C</span>`; } catch (e) { document.getElementById('weather-display').innerHTML = "Error Clima"; }
                }, (error) => { fetchWeatherDefault(); });
            } else { fetchWeatherDefault(); }
        }

        async function fetchWeatherDefault() { 
            try { const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=20.62&longitude=-103.24&current_weather=true'); const data = await res.json(); const temp = Math.round(data.current_weather.temperature); document.getElementById('weather-display').innerHTML = `<span>üå§ Tonal√°</span> <span style="opacity:0.3">|</span> <span>${temp}¬∞C</span>`; } catch (e) { document.getElementById('weather-display').innerHTML = "Clima no disponible"; } 
        }

        window.updateClock = function() { 
            const now = new Date(); 
            document.getElementById('clock-time').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
            document.getElementById('clock-date').textContent = now.toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'}); 
        };

        // LAS 5 COLUMNAS DEFINITIVAS
        const columns = [
            {id:'pending', title:'üî¥ Dise√±o / Pendiente', color:'#e11d48'},
            {id:'press', title:'üü° En Prensa', color:'#f59e0b'},
            {id:'maquila', title:'üöö En Maquila', color:'#8b5cf6'},
            {id:'finish', title:'üîµ Acabados', color:'#0ea5e9'},
            {id:'ready', title:'üü¢ Listo / Entregar', color:'#10b981'}
        ];
        let collapsedCols = { pending: false, press: false, maquila: false, finish: false, ready: false };

        window.toggleCol = function(id) { collapsedCols[id] = !collapsedCols[id]; renderBoard(); };
        window.toggleAllCols = function() { const state = !Object.values(collapsedCols).every(v => v === true); Object.keys(collapsedCols).forEach(k => collapsedCols[k] = state); renderBoard(); };

        window.renderBoard = function() { 
            const container = document.getElementById('board-container'); container.innerHTML = ''; 
            columns.forEach(col => { 
                const isCollapsed = collapsedCols[col.id]; 
                const orders = (localDB.orders || []).filter(o => o.status === col.id); 
                const div = document.createElement('div'); 
                div.className = `column ${isCollapsed ? 'retracted' : ''}`; 
                div.innerHTML = `<div class="col-header" onclick="toggleCol('${col.id}')"><div style="display:flex; gap:10px; align-items:center;"><div style="width:10px; height:10px; border-radius:50%; background:${col.color}"></div><span style="font-weight:600;">${col.title}</span></div><div style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:10px; font-size:0.8rem;">${orders.length}</div></div><div class="col-body">${orders.map(o => getCardHTML(o)).join('')}</div>`; 
                container.appendChild(div); 
            }); 
        };

        function getCardHTML(o) { 
            const bal = o.total - o.advance; const balTag = bal > 0 ? `<span style="color:var(--primary)">Debe: $${bal.toFixed(2)}</span>` : `<span style="color:var(--success)">PAGADO</span>`; 
            
            // LOGICA DEL SMART BADGE (Etiquetas de Proveedor)
            let badgeHTML = '';
            if(o.vendor) { badgeHTML = `<div class="card-badge badge-external">üöö ${o.vendor}</div>`; } 
            else { badgeHTML = `<div class="card-badge badge-internal">üè† Interno</div>`; }

            let actBtn = '';
            if (o.status === 'ready') {
                actBtn = `<div class="card-actions"><button class="act-btn" onclick="event.stopPropagation(); sendWA(${o.id})" title="Enviar WA">üí¨</button><button class="act-btn" onclick="event.stopPropagation(); deliverOrder(${o.id})" title="Entregar" style="color:var(--success);">‚úÖ</button></div>`;
            } else {
                actBtn = `<button class="act-btn" onclick="event.stopPropagation(); moveOrder(${o.id})" title="Avanzar">‚û°</button>`;
            }
            return `<div class="card" onclick="openEditor(${o.id})"><div style="display:flex; justify-content:space-between; align-items:flex-start;">${badgeHTML}<span class="card-folio">#${o.folio}</span></div><div class="card-client">${o.client}</div><div class="card-desc">${o.desc || o.title}</div><div class="card-foot"><span style="font-size:0.8rem; font-weight:bold;">${balTag}</span>${actBtn}</div></div>`; 
        }

        // FLUJO INTELIGENTE (Smart Flow)
        window.moveOrder = function(id) { 
            const o = localDB.orders.find(x => x.id === id); 
            let next = null;
            if(o.status === 'pending') next = 'press';
            else if(o.status === 'press') next = o.vendor ? 'maquila' : 'finish'; // Salta Maquila si es interno
            else if(o.status === 'maquila') next = 'finish';
            else if(o.status === 'finish') next = 'ready';
            
            if(next) { o.status = next; saveToCloud(); } 
        };

        window.deliverOrder = function(id) {
            if(!confirm("¬øConfirmar entrega y mover al historial?")) return;
            const idx = localDB.orders.findIndex(x => x.id === id);
            if(idx > -1) {
                const order = localDB.orders[idx];
                order.deliveredDate = Date.now();
                if(!localDB.history) localDB.history = [];
                localDB.history.push(order);
                localDB.orders.splice(idx, 1);
                saveToCloud();
            }
        };

        window.openHistory = function() { document.getElementById('history-modal').classList.add('active'); renderHistory('today'); };
        window.renderHistory = function(filter) {
            document.querySelectorAll('.h-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.h-btn[onclick="renderHistory('${filter}')"]`).classList.add('active');
            const container = document.getElementById('history-list-container'); container.innerHTML = '';
            let total = 0; const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const startOfWeek = startOfDay - (now.getDay() * 24 * 60 * 60 * 1000);
            const list = (localDB.history || []).filter(h => { if(filter === 'today') return h.deliveredDate >= startOfDay; if(filter === 'week') return h.deliveredDate >= startOfWeek; return true; }).sort((a,b) => b.deliveredDate - a.deliveredDate);
            list.forEach(h => { total += h.total; container.innerHTML += `<div class="history-row"><div class="h-folio">#${h.folio}</div><div class="h-client">${h.client} <div class="h-desc">${h.desc}</div></div><div style="color:#666; font-size:0.8rem;">${new Date(h.deliveredDate).toLocaleDateString()}</div><div class="h-amount">$${h.total.toFixed(2)}</div></div>`; });
            document.getElementById('history-total-val').textContent = '$' + total.toFixed(2);
        };
        window.clearHistory = function() { if(confirm("¬øBorrar historial?")) { localDB.history = []; saveToCloud(); renderHistory('all'); } };

        // ACTUALIZAR SELECT DE PROVEEDORES EN EL EDITOR
        function updateVendorSelect() {
            const select = document.getElementById('inp-vendor');
            const currentVal = select.value;
            select.innerHTML = '<option value="">üè† Producci√≥n Interna (Local)</option>';
            (localDB.config.vendors || []).forEach(v => { select.innerHTML += `<option value="${v}">üöö ${v}</option>`; });
            select.value = currentVal; 
        }

        // GENERAR BOTONES DE ACABADOS DIN√ÅMICOS EN EL EDITOR
        window.initFinishes = function() { 
            const arr = localDB.config.finishes || defaultFinishes;
            document.getElementById('finishes-grid').innerHTML = arr.map(f => `<div onclick="this.classList.toggle('active')" class="finish-item" data-v="${f}">${f}</div>`).join(''); 
        };

        let curId = null;
        window.openEditor = function(id=null) {
            curId = id; document.getElementById('editor-modal').classList.add('active');
            document.querySelectorAll('input:not([type="checkbox"]), textarea').forEach(i => i.value='');
            document.querySelectorAll('.finish-item').forEach(i => i.classList.remove('active'));
            document.getElementById('check-iva').checked = false;
            updateVendorSelect(); 

            if(id) {
                let o = localDB.orders.find(x => x.id === id) || localDB.history.find(x => x.id === id);
                if(o) {
                    const s = (eid, val) => document.getElementById(eid).value = val || '';
                    s('inp-client', o.client); s('inp-phone', o.phone); s('inp-folio', o.folio); s('inp-date', o.date); s('inp-date-delivery', o.dateDelivery);
                    s('inp-vendor', o.vendor); 
                    s('inp-qty', o.qty); s('inp-desc', o.desc); s('inp-f-start', o.fStart); s('inp-f-end', o.fEnd); s('cost-folio', o.cFolio);
                    s('inp-p-type', o.pType); s('inp-p-size', o.pSize); s('inp-p-orig', o.pOrig); s('inp-p-int1', o.pInt1); s('inp-p-int2', o.pInt2); s('inp-p-final', o.pFinal); s('cost-paper', o.cPaper);
                    s('inp-f-sel', o.fSel); s('inp-f-line', o.fLine); s('inp-f-inks', o.fInks); s('inp-f-col', o.fCol); s('inp-v-sel', o.vSel); s('inp-v-line', o.vLine); s('inp-v-inks', o.vInks); s('inp-v-col', o.vCol); s('cost-print', o.cPrint);
                    s('inp-plates-qty', o.platesQty); s('inp-negs-qty', o.negsQty); s('inp-shots-qty', o.shotsQty); s('cost-plates', o.cPlates);
                    
                    // Al abrir la orden, encender los botones de acabados guardados
                    if(o.finishes) o.finishes.forEach(f => { const el = document.querySelector(`.finish-item[data-v="${f}"]`); if(el) el.classList.add('active'); });
                    
                    s('inp-f-other', o.fOther); s('cost-finish', o.cFinish); s('inp-obs', o.obs); s('inp-email', o.email);
                    document.getElementById('check-iva').checked = o.hasIVA; s('inp-advance', o.advance);
                }
            } else {
                let nf = (localDB.config.folio || 0) + 1; if(nf > 1000) nf = 1;
                document.getElementById('inp-folio').value = nf.toString().padStart(4,'0');
                document.getElementById('inp-date').value = new Date().toLocaleDateString();
                document.getElementById('inp-vendor').value = ""; 
            }
            calc();
        };

        window.calc = function() {
            const num = (id) => parseFloat(document.getElementById(id).value)||0;
            let cFolio = num('cost-folio'), cPaper = num('cost-paper'), cPrint = num('cost-print'), cPlates = num('cost-plates'), cFinish = num('cost-finish');
            document.getElementById('txt-folio').textContent = '$'+cFolio.toFixed(2); document.getElementById('txt-paper').textContent = '$'+cPaper.toFixed(2); document.getElementById('txt-print').textContent = '$'+cPrint.toFixed(2); document.getElementById('txt-plates').textContent = '$'+cPlates.toFixed(2); document.getElementById('txt-finish').textContent = '$'+cFinish.toFixed(2);
            let sub = cFolio + cPaper + cPrint + cPlates + cFinish; let iva = document.getElementById('check-iva').checked ? sub * 0.16 : 0; let total = sub + iva;
            let adv = num('inp-advance'); let bal = total - adv;
            document.getElementById('disp-total').textContent = '$'+total.toFixed(2); document.getElementById('disp-balance').textContent = '$'+bal.toFixed(2); document.getElementById('disp-balance').style.color = bal > 0 ? '#e11d48' : '#10b981';
        };

        window.saveOrder = function() {
            const val = (id) => document.getElementById(id).value;
            if(!val('inp-client')) return alert('Falta Cliente');
            const fins = []; document.querySelectorAll('.finish-item.active').forEach(e => fins.push(e.dataset.v));
            const order = {
                id: curId || Date.now(), client: val('inp-client'), phone: val('inp-phone'), folio: val('inp-folio'), date: val('inp-date'),
                dateDelivery: val('inp-date-delivery'), vendor: val('inp-vendor'), 
                qty: val('inp-qty'), desc: val('inp-desc'), fStart: val('inp-f-start'), fEnd: val('inp-f-end'), cFolio: val('cost-folio'),
                pType: val('inp-p-type'), pSize: val('inp-p-size'), pOrig: val('inp-p-orig'), pInt1: val('inp-p-int1'), pInt2: val('inp-p-int2'), pFinal: val('inp-p-final'), cPaper: val('cost-paper'),
                fSel: val('inp-f-sel'), fLine: val('inp-f-line'), fInks: val('inp-f-inks'), fCol: val('inp-f-col'), vSel: val('inp-v-sel'), vLine: val('inp-v-line'), vInks: val('inp-v-inks'), vCol: val('inp-v-col'), cPrint: val('cost-print'),
                platesQty: val('inp-plates-qty'), negsQty: val('inp-negs-qty'), shotsQty: val('inp-shots-qty'), cPlates: val('cost-plates'),
                finishes: fins, fOther: val('inp-f-other'), cFinish: val('cost-finish'), obs: val('inp-obs'), email: val('inp-email'),
                hasIVA: document.getElementById('check-iva').checked, advance: val('inp-advance'), total: parseFloat(document.getElementById('disp-total').textContent.replace('$','')),
                status: curId ? (localDB.orders.find(x => x.id === curId)?.status || 'pending') : 'pending'
            };
            const activeIdx = localDB.orders.findIndex(x => x.id === curId);
            if(activeIdx > -1 || !curId) {
                if(curId) localDB.orders[activeIdx] = order; 
                else { localDB.orders.push(order); localDB.config.folio = parseInt(order.folio); }
                saveToCloud(); closeModal();
            } else { alert("Orden archivada/no encontrada."); }
        };

        window.deleteOrder = function() { if(confirm('¬øEliminar?')) { localDB.orders = localDB.orders.filter(x => x.id !== curId); saveToCloud(); closeModal(); } };
        window.openCaja = function() { document.getElementById('caja-modal').classList.add('active'); let c = 0, p = 0; localDB.orders.forEach(o => { c += parseFloat(o.advance||0); let b = o.total - o.advance; if(b>0) p+=b; }); document.getElementById('caja-cobrado').textContent = '$'+c.toFixed(2); document.getElementById('caja-por-cobrar').textContent = '$'+p.toFixed(2); };
        
        /* ----------------------------------------------------
           GESTI√ìN DIN√ÅMICA DE MAQUILEROS Y ACABADOS (CONFIG)
        ----------------------------------------------------- */
        window.openConfig = function() { 
            document.getElementById('config-modal').classList.add('active'); 
            document.getElementById('cfg-name').value = localDB.config.name; document.getElementById('cfg-folio').value = localDB.config.folio; document.getElementById('cfg-pass').value = localDB.config.pass; document.getElementById('cfg-norm').value = localDB.config.accNorm; document.getElementById('cfg-fisc').value = localDB.config.accFisc; 
            renderConfigVendors();
            renderConfigFinishes();
        };
        
        // MAQUILEROS
        window.renderConfigVendors = function() {
            const list = document.getElementById('cfg-vendors-list');
            if(!localDB.config.vendors || localDB.config.vendors.length === 0) { list.innerHTML = '<div style="color:#666; font-size:0.8rem; text-align:center;">No hay proveedores</div>'; return; }
            list.innerHTML = localDB.config.vendors.map((v, i) => `<div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #222; padding:8px 0;"><span style="font-size:0.9rem; color:#ddd;">üöö ${v}</span><button onclick="removeVendor(${i})" style="background:var(--primary); border:none; color:white; border-radius:4px; padding:3px 8px; cursor:pointer; font-weight:bold;">‚úï</button></div>`).join('');
        };
        window.addVendor = function() {
            const v = document.getElementById('cfg-new-vendor').value.trim();
            if(v) { if(!localDB.config.vendors) localDB.config.vendors = []; localDB.config.vendors.push(v); document.getElementById('cfg-new-vendor').value = ''; renderConfigVendors(); saveToCloud(); }
        };
        window.removeVendor = function(i) { if(confirm('¬øBorrar a este maquilero?')) { localDB.config.vendors.splice(i, 1); renderConfigVendors(); saveToCloud(); } };

        // ACABADOS
        window.renderConfigFinishes = function() {
            const list = document.getElementById('cfg-finishes-list');
            if(!localDB.config.finishes || localDB.config.finishes.length === 0) { list.innerHTML = '<div style="color:#666; font-size:0.8rem; text-align:center;">No hay acabados</div>'; return; }
            list.innerHTML = localDB.config.finishes.map((f, i) => `<div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #222; padding:8px 0;"><span style="font-size:0.9rem; color:#ddd;">üõ†Ô∏è ${f}</span><button onclick="removeConfigFinish(${i})" style="background:var(--primary); border:none; color:white; border-radius:4px; padding:3px 8px; cursor:pointer; font-weight:bold;">‚úï</button></div>`).join('');
        };
        window.addConfigFinish = function() {
            const f = document.getElementById('cfg-new-finish').value.trim();
            if(f) { if(!localDB.config.finishes) localDB.config.finishes = []; localDB.config.finishes.push(f); document.getElementById('cfg-new-finish').value = ''; renderConfigFinishes(); initFinishes(); saveToCloud(); }
        };
        window.removeConfigFinish = function(i) { if(confirm('¬øBorrar este acabado?')) { localDB.config.finishes.splice(i, 1); renderConfigFinishes(); initFinishes(); saveToCloud(); } };

        window.saveConfig = function() { 
            localDB.config.name = document.getElementById('cfg-name').value; localDB.config.folio = parseInt(document.getElementById('cfg-folio').value); localDB.config.pass = document.getElementById('cfg-pass').value; localDB.config.accNorm = document.getElementById('cfg-norm').value; localDB.config.accFisc = document.getElementById('cfg-fisc').value; 
            saveToCloud(); closeModal(); 
        };

        window.sendWA = function(id) { const o = localDB.orders.find(x => x.id === id); const bal = o.total - o.advance; let bank = o.hasIVA ? localDB.config.accFisc : localDB.config.accNorm; let txt = `Hola ${o.client}, te saludamos de ${localDB.config.name}.\nTu pedido "${o.desc||o.title}" (#${o.folio}) est√° LISTO.\nSaldo: $${bal.toFixed(2)}${o.hasIVA?' (IVA Inc.)':''}.\n\nDep√≥sito:\n${bank}`; window.open(`https://wa.me/521${o.phone}?text=${encodeURIComponent(txt)}`); };
        window.closeModal = function() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); };
        window.toggleAcc = function(h) { h.parentElement.classList.toggle('open'); };
        
        setInterval(updateClock, 1000); 
        updateClock();
        document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });
        document.getElementById('login-pass').addEventListener('keypress', (e) => { if(e.key==='Enter') attemptLogin(); });

    </script>
</body>
</html>